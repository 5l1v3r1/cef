<!DOCTYPE HTML>
<html>
<head>
    <title>Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--link rel="stylesheet" type="text/css" href="https://necolas.github.io/normalize.css/8.0.0/normalize.css"-->
    <link rel="stylesheet" type="text/css" href="http://getskeleton.com/dist/css/skeleton.css">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/custom.css') }}">
    <script src="https://unpkg.com/vue@latest/dist/vue.js"></script>
</head>
<body>
<div id="app">
    <div class="container">
        <div class="row">
            <dashboard></dashboard>
        </div>
    </div>
</div>
<script>
Vue.component('dashboard', {
    template: {% raw %}`
        <div class="twelve columns">
            <h3>CORS Exploitation Framework (CEF)</h3>
            <panel label="add an attack">
                <add-attack></add-attack>
            </panel>
            <panel label="run an attack">
                <run-attack></run-attack>
            </panel>
            <panel label="view results">
                <view-results></view-results>
            </panel>
        </div>
    `{% endraw %},
});

Vue.component('panel', {
    props: ['label'],
    template: {% raw %}`
        <div>
            <label class="collapsible" v-on:click="collapse">{{ label }}</label>
            <div class="content">
                <slot></slot>
            </div>
        </div>
    `{% endraw %},
    methods: {
        collapse: function(event) {
            event.target.classList.toggle("active");
            var content = event.target.nextElementSibling;
            if (content.style.display === "block") {
                content.style.display = "none";
            } else {
                content.style.display = "block";
            }
        },
    }
});

Vue.component('add-attack', {
    template: {% raw %}`
        <div>
            <form v-on:submit.prevent="addAttack">
                <input type="text" v-model="attackForm.method" placeholder="method"> <span>http method for the attack</span><br>
                <input type="text" v-model="attackForm.url" placeholder="url"> <span>target url for the attack</span><br>
                <input type="text" v-model="attackForm.payloadExp" placeholder="payload expression"> <span>python expression using 'u' and 'p'</span><br>
                <input type="text" v-model="attackForm.contentType" placeholder="content type"> <span>content type header value of the payload</span><br>
                <input type="text" v-model="attackForm.success" placeholder="success match"> <span>string in response indicating success</span><br>
                <input type="text" v-model="attackForm.fail" placeholder="failure match"> <span>string in response indicating failure</span><br>
                <button type="submit">add attack</button>
            </form>
            <hr>
        </div>
    `{% endraw %},
    data: function() {
        return {
            attackForm: {
                method: '',
                url: '',
                payloadExp: '',
                contentType: '',
                success: '',
                fail: '',
            },
        }
    },
    methods: {
        addAttack: function(event) {
            fetch('{{ url_for('add_attacks') }}', {
                  method: 'POST',
                  body: JSON.stringify(this.attackForm),
                  headers:{
                    'Content-Type': 'application/json'
                  }
            })
            .then(response => response.json())
            .then(json => {
                // update the attack select
                // FIX: this.attacks.push(json.attack);
                // reset the form
                Object.keys(this.attackForm).forEach((k) => {
                    this.attackForm[k] = '';
                });
            })
        },
    },
});

Vue.component('run-attack', {
    template: {% raw %}`
        <div>
            <select v-model="attack">
                <option v-for="attack in attacks" v-bind:value="attack.id">{{ attack.url }}</option>
            </select><br>
            <select v-model="filename">
                <option v-for="file in files">{{ file }}</option>
            </select><br>
            <button v-on:click="runAttack">run attack!</button> <span>{{ status }}</span>
            <hr>
        </div>
    `{% endraw %},
    data: function() {
        return {
            attack: '',
            attacks: [],
            filename: '',
            files: [],
            status: '',
        }
    },
    methods: {
        getAttacks: function(event) {
            fetch('{{ url_for('get_attacks') }}')
            .then(response => response.json())
            .then(json => {
                this.attacks = json.attacks;
                if (this.attacks.length > 0) {
                    this.attack = 1;
                }
                this.files = json.files;
                if (this.files.length > 0) {
                    this.filename = json.files[0];
                }
            });
        },
        runAttack: function(event) {
            fetch('{{ url_for('run_attack') }}', {
                  method: 'POST',
                  body: JSON.stringify({id: this.attack, filename: this.filename}),
                  headers:{
                    'Content-Type': 'application/json'
                  }
            })
            .then(response => response.text())
            .then(text => {
                // update the status
                this.getStatus();
            })
        },
        getStatus: function(event) {
            fetch('{{ url_for('get_status') }}')
            .then(response => response.json())
            .then(json => {
                this.status = json.status.message;
                if (json.status.length > 0) {
                    this.status += ' '+json.status.length;
                }
            });
        },
    },
    created() {
        // preload attacks
        this.getAttacks();
        // preload status
        this.getStatus();
    },
    mounted() {
        // maintain status
        setInterval(function () {
            this.getStatus();
        }.bind(this), 5000); 
    },
});

Vue.component('view-results', {
    template: {% raw %}`
        <div>
            <table v-if="results.length > 0" class="center">
                <thead>
                    <tr><th>created</th><th>target</th><th>payload</th><th>node</th></tr>
                </thead>
                <tbody>
                    <tr v-for="result in results" v-bind:key="result.id" v-bind:result="result"><td>{{ result.created }}</td><td>{{ result.attack.url }}</td><td>{{ result.payload }}</td><td>{{ result.node.fingerprint }}</td></tr>
                </tbody>
            </table>
            <hr>
        </div>
    `{% endraw %},
    data: function() {
        return {
            results: [],
        }
    },
    evtSource: false,
    methods: {
        setupStream: function(event) {
            this.$options.evtSource = new EventSource("{{ url_for('stream_results') }}");
            this.$options.evtSource.addEventListener('message', event => {
                var data = JSON.parse(event.data);
                this.results.push(data);
            }, false);
        },
        teardownStream: function(event) {
            if (this.$options.evtSource !== false) {
                this.$options.evtSource.close();
            }
        },
        getResults: function(event) {
            fetch('{{ url_for('get_results') }}')
            .then(response => response.json())
            .then(json => {
                this.results = json.results;
            });
        },
    },
    created() {
        // preload results
        this.getResults();
        // setup stream
        //this.setupStream();
        //window.addEventListener('beforeunload', this.teardownStream, false);
    },
    mounted() {
        // maintain results
        setInterval(function () {
            this.getResults();
        }.bind(this), 5000); 
    },
});

// define tha vue app
var app = new Vue({
    el: '#app',
});
</script>
</body>
</html>
